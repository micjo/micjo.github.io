<!DOCTYPE html>
<html lang="en">
<head>
		<title>micjo's blog</title>
		<meta charset="utf-8" />
		<link rel="profile" href="http://gmpg.org/xfn/11" />
		<link rel="stylesheet" type="text/css" href="/theme/css/style.css" />
		<link rel='stylesheet' id='oswald-css'  href='http://fonts.googleapis.com/css?family=Oswald&#038;ver=3.3.2' type='text/css' media='all' />
		<style type="text/css">
			body.custom-background { background-color: #f5f5f5; }
		</style>
		<link rel="alternate" type="application/atom+xml"
			title="micjo's blog â€” Flux Atom"
			href="/" /> 
		<!--[if lte IE 8]><script src="/theme/js/html5shiv.js"></script><![endif]-->
</head>

<body class="home blog custom-background " >
	<div id="container">
		<div id="header">
				<h1 id="site-title"><a href="">micjo's blog</a></h1>
		</div><!-- /#banner -->
		
		<div id="menu">
			<div class="menu-navigation-container">
				<ul id="menu-navigation" class="menu">
						<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="/category/fosdem.html">FOSDEM</a></li>
						<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="/category/multithreading.html">Multithreading</a></li>
						<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="/category/python-ruby.html">Python, Ruby</a></li>
						<li  class="active" class="menu-item menu-item-type-post_type menu-item-object-page"><a href=""></a></li>
						<li  class="active" class="menu-item menu-item-type-post_type menu-item-object-page"><a href=""></a></li>

				</ul>
			</div> <!--/#menu-navigation-container-->
		</div><!-- /#menu -->
		
		<div class="page-title">
		</div>
	
		<div id="contents">
<div class="post type-post status-publish format-standard hentry category-general" id="post">
	<div class="entry-meta">
		<div class="date"><a href="/semaphore-vs-mutex.html">za 17 februari 2018</a></div>
		<span class="byline">By <a href="/author/michiel-jordens.html">Michiel Jordens</a></span>
			<span class="cat-links"><a href="/category/multithreading.html" title="View all posts in Multithreading" rel="category tag">Multithreading</a></span>
	</div> <!-- /#entry-meta -->
	<div class="main">
		<h2 class="entry-title">
			<a href="/semaphore-vs-mutex.html" title="Permalink to Semaphore vs Mutex" rel="bookmark">Semaphore vs Mutex</a>
		</h2>
		<div class="entry-content">
			<p>This post will describe the differences between a semaphore and a
mutex and some of the pitfalls you may encounter if you do not take
these into consideration. Both semaphores and mutexes are concepts
that come into play with threading and sharing resources between
threads. Conceptually a mutex is for ownership and a semaphore is
for synchronization.</p>
<p>Many a coursebook consider a mutex to be a binary semaphore.
however this is a gross oversimplification that will have detrimental
effects on real-time/interrupt behavior. It is therefore false to assume
a mutex is merely a binary semaphore.</p>
<p>In order to explain the key difference between a mutex and a
semaphore, one must understand the concept of priority inversion
and priority inheritance.</p>
<h2>Priority inversion</h2>
<p>Given tasks a,b and c with respectively increasing priority in a
real time operating system. Say task a, lowest priority, is running and
obtains a lock l (i am deliberately not specifying if it's a mutex or
semaphore) to manipulate data x . While it has the lock, it gets
interrupted/preempted by task b. Task b on its turn gets interrupted
by task c. Task c requires access to data x and needs to obtain lock l.
However it is unable to do so as task A has not yet relinquished the
resources. This is also referred to as resource contention.</p>
<p>As task c is simply waiting for the lock, the scheduler will suspend task
c and allow task b to finish running. Once b is finished, the scheduler
will schedule task a. Only when the lock is released by task a, can task c
continue. This means that task b erroneously has a higher priority than
task c.</p>
<p><img src="img/priority_inversion.png" alt="priority_inversion" style="width: 600px;" /></p>
<h2>Priority inheritance</h2>
<p>To solve the problem of priority inversion, one needs priority inhertance.
Priority inheritance will make sure that if there is resource contention
between 2 tasks of different priority, the lower priority task will get
promoted to higher priority task. In the example described above, this
means that task a would get the same priority as task c. In other words,
task a would be allowed to finish before task b. Consequently, task c
would be allowed to finished before task b.</p>
<p><img src="img/priority_inheritance.png" alt="priority_inheritance" style="width: 600px;" /></p>
<h2>Semaphore vs mutex (continued)</h2>
<p>A semaphore allows sharing resources between multiple threads. For example:
a system has 5 serial interfaces which can be distributed between threads.
The sempahore would be initialized with value 5 and if a thread requires
acess it will 'wait' for it. If the semaphore is above 0, the wait will
return immediately and decrement the sempahore. If the sempahore is 0,
the wait will block until another thread posts/releases/increments the
semaphore.</p>
<p>A mutex is used for ownership. While you have the mutex, meaning you have
locked it, you can manipulate the shared data. When you are done, you release
the lock and another thread can lock the mutex and access the shared data.
The actions performed while you have the lock, is also called the critical
section. Note that there is a binary behavior: You have the lock or you
don't. Whereas with a sempahore more than 1 thread can access the
resource at the same time, with a mutex this is impossible.</p>
<p>Now the step to call a mutex a binary semaphore might seem logical.
After all, it is just sharing a resource with binary behavior:</p>
<ul>
<li>Semaphore = 1: it can be locked</li>
<li>Semaphore = 0: it is locked</li>
</ul>
<p>However this is where the big difference comes into play.
<strong>The task that has the lock, is transparent to the scheduler.</strong>
This is vital information to allow for priority inheritance. If you
would not have this information, how do you know which task to elevate?
If you would use a semaphore, this is exactly the information that is missing.
With a semaphore any thread can wait or post to the semaphore. There is
no context of which task was responsible. Consequently there is no
option to perform priority inheritance.</p>
<p>To recap:</p>
<ul>
<li>Priority inheritance is impossible with semaphores.</li>
<li>Priority inheritance is impossible with binary semaphores</li>
<li>Priority inheritance is possible with mutex</li>
</ul>
<p><strong>Mutexes are not binary sempahores.</strong></p>
<h2>Semaphores in C++11</h2>
<p>Sadly, in the standard library, there is no semaphore available. While
you can wrap the POSIX interface in a class, this is anything but elegant.
What the standard library does offer however, is a <a href="http://en.cppreference.com/w/cpp/thread/condition_variable">condition_variable</a>.
This should provide the same functionality.</p>
<p>Do note the subtle difference between wait_until and wait_for. wait_until
uses an absolute time-point, measured since the epoch. wait_for uses a relative
time interval. At first glance, this seems to be just a minor difference.
However this has some important consequences. As you can always experience
spurious wake ups, it is up to the caller to check if it was spurious or not.
If it was spurious, the caller should call the wait function once more. If You
use the wait_for function, every spurious wake up can delay your wait considerably.</p>
<p>If you use wait_until, even if you call it again after a spurious wakeup, the
end time is fixed. With wait_for this is undefined. If you use a predicate, this
is not relevant, as spurious wake ups are avoided.</p>
<p>For an example, have a look at my github repo <a href="https://github.com/micjo/snippets/blob/master/cpp/thread_example.cpp">here</a>.
In this example I use the semaphore to immediately stop a detached thread on
object destruction.</p>
		</div> <!--/#entry-content-->
    		<span class="tag-links"><strong>Tagged</strong>
 <a href="/tag/c11.html" rel="tag">C++11</a>,  <a href="/tag/mutex.html" rel="tag">Mutex</a>,  <a href="/tag/semaphore.html" rel="tag">Semaphore</a>    		</span>
	</div> <!--/#main-->
</div>  <!--/#post--><div class="post type-post status-publish format-standard hentry category-general" id="post">
	<div class="entry-meta">
		<div class="date"><a href="/fosdem-2018-gstreamer.html">zo 11 februari 2018</a></div>
		<span class="byline">By <a href="/author/michiel-jordens.html">Michiel Jordens</a></span>
			<span class="cat-links"><a href="/category/fosdem.html" title="View all posts in FOSDEM" rel="category tag">FOSDEM</a></span>
	</div> <!-- /#entry-meta -->
	<div class="main">
		<h2 class="entry-title">
			<a href="/fosdem-2018-gstreamer.html" title="Permalink to GStreamer Fosdem 2018" rel="bookmark">GStreamer Fosdem 2018</a>
		</h2>
		<div class="entry-content">
			<h1><a href="https://fosdem.org/2018/schedule/event/om_gst_embedded/">Gstreamer for embedded devices</a></h1>
<p>GStreamer is widespread. It's used by TVs (LG, Samsung), 
settopboxes, In-flight-entertainment, the space station
and the list goes on.</p>
<h2>Some new features that are now supported:</h2>
<ul>
<li>Better zero-copy support (tee)</li>
<li>Stablized v4l2 names</li>
<li>hardware codecs</li>
<li>Changing decoder resolutions at runtime</li>
</ul>
<h2>KMS improvements</h2>
<p><em>KMS is the linux driver that puts the pixels on your screen</em></p>
<ul>
<li>DMAbuf pool</li>
<li>video-overlay</li>
<li>more formats and devices</li>
</ul>
<h2>Embedded OpenGL:</h2>
<ul>
<li>Vivante EGL FB support (increases performance on imx6)</li>
<li>Moved into base and frozen API</li>
<li>Mesa DMAbuf export support</li>
</ul>
<h2>Process seperation:</h2>
<p><em>This allows putting a sink in a different process and
use the source as a slave</em></p>
<ul>
<li>Master/Slave model</li>
<li>Useful for terrible APIs that only work with high privileges</li>
</ul>
<h2>Near future:</h2>
<ul>
<li>DRM modifiers</li>
<li>GStreamer CI on embedded systems</li>
<li>V4L2 stateless codecs</li>
</ul>
<h1><a href="https://fosdem.org/2018/schedule/event/gstreamer_for_tiny_devices/">Gstreamer for tiny devices</a></h1>
<p>This was a talk trying to get gstreamer to compile and 
run on a device with a very small footprint. </p>
<p>There were 3 things that he did :</p>
<ul>
<li>Link statically with libtool</li>
<li>Butcher glib (even with compile options certain
sections were still compiled in the library)</li>
<li>Compress the binary with upx</li>
</ul>
<p>To link statically he had to use :</p>
<ul>
<li>GST_PLUGIN_STATIC_DECLARE</li>
<li>GST_PLUGIN_STATIC_REGISTER</li>
<li>GST_DEBUG=GST_PLUGIN_LOADING:4</li>
</ul>
<p>An interesting tool he used is called 
<a href="https://github.com/google/bloaty">bloaty mcbloatface</a>.</p>
<h1><a href="https://fosdem.org/2018/schedule/event/om_gst_dbg/">Modern tools to debug GStreamer applications</a></h1>
<h2>GstTracer</h2>
<ul>
<li>available from 1.8</li>
<li>Traces modules loaded at runtime</li>
<li>Post-run analysis and live introspection</li>
<li>Monitoring hooks</li>
<li>Formatted output</li>
</ul>
<h2>Stats Tracers</h2>
<ul>
<li>GST_TRACER="stats,usage"</li>
<li>GST_DEBUG=GST_TRACER</li>
<li>gst-stats *.log</li>
</ul>
<h2>Latency Tracers</h2>
<p>This can measure the time it takes for each buffer
to travel from source to sink.
GST_TRACERS=latency</p>
<h2>Leaks Tracer</h2>
<ul>
<li>Tracks refcounts of GObjefct and GstMiniObject, Only track leaks in gst code.</li>
<li>Raises warning on leaks.</li>
<li>Integrated in 1.10.</li>
<li>No false positives</li>
<li>Lighter/faster than valgrind.</li>
<li>Hook into CI / QA system</li>
</ul>
<h2>Tracing leaks</h2>
<ul>
<li>GST_TRACER=leaks </li>
<li>GST_TRACER=stack-trace</li>
<li>Track ref/unref operations (check-refs=true)</li>
<li>List alive objects while running (SIGUSR1)</li>
<li>Check points (SIGUSR2)</li>
</ul>
<p>You can use GST_TRACER=leaks to get a high level overview.
If you see one object that has leaks, you can use the
GST_TRACER=stack-trace to really zoom in on that object by
visualizing the stack trace.</p>
<h2><a href="https://github.com/RidgeRun/gst-shark">GSTShark</a></h2>
<ul>
<li>Inter latency</li>
<li>buffer rate on src pad</li>
<li>schedule time</li>
<li>Queues level</li>
</ul>
<p>GSTShark can show which element is underperforming.
It supports creating graphs which are quite nice in showing
where the bottlenecks are. This is not part of gstreamer.
These are a few plugin scripts you have to install seperately</p>
<h2><a href="https://github.com/gdesmott/gst-log-parser">gst-log-parser</a></h2>
<ul>
<li>GStreamer logs parsing library</li>
<li>High level objects to manipulate logs</li>
<li>Easy filtering, mapping, etc (iterator)</li>
<li>ts-diff : highlight highest timestamps gaps</li>
</ul>
		</div> <!--/#entry-content-->
    		<span class="tag-links"><strong>Tagged</strong>
 <a href="/tag/fosdem.html" rel="tag">FOSDEM</a>,  <a href="/tag/gstreamer.html" rel="tag">gstreamer</a>,  <a href="/tag/opensource.html" rel="tag">OpenSource</a>    		</span>
	</div> <!--/#main-->
</div>  <!--/#post--><div class="post type-post status-publish format-standard hentry category-general" id="post">
	<div class="entry-meta">
		<div class="date"><a href="/fosdem-2018.html">zo 11 februari 2018</a></div>
		<span class="byline">By <a href="/author/michiel-jordens.html">Michiel Jordens</a></span>
			<span class="cat-links"><a href="/category/fosdem.html" title="View all posts in FOSDEM" rel="category tag">FOSDEM</a></span>
	</div> <!-- /#entry-meta -->
	<div class="main">
		<h2 class="entry-title">
			<a href="/fosdem-2018.html" title="Permalink to Fosdem 2018" rel="bookmark">Fosdem 2018</a>
		</h2>
		<div class="entry-content">
			<h1>Fosdem 2018</h1>
<p>Going to FOSDEM is always somewhat of a reality check.
You see how much you stay in your silo at work, 
how few women there are in our sector and 
how small the campus has gotten over the last few years.
Meeting old colleagues and learning 
new things always bring me back however.</p>
<p>There is never enough time to visit all the talks 
you want to go to. FOSDEM is a week worth of 
seminars condensed into 1 weekend.</p>
<h2>Day 1</h2>
<p>I attended a few talks today. The most interesting ones where:</p>
<ul>
<li><a href="https://fosdem.org/2018/schedule/event/linux_up_and_running/">How to keep your embedded linux device up and running</a></li>
<li><a href="fosdem-2018-gstreamer.html">GStreamer talks</a></li>
<li><a href="https://fosdem.org/2018/schedule/event/riscv/">Igniting the open hardware ecosystem with RISC-V</a></li>
</ul>
<p>While the actual application of the first talk remains to be seen,
they did apply an interesting way of working. The concepts
of 1 domain, the server world, were applied to another, the embedded 
domain. Some tweaking was required as you do not have the same amount
of resources on an embedded device.</p>
<p>I devoted a seperate post to to the gstreamer talks as this was too much
information to add here.</p>
<p>RISC-V, the third talk in the list, is an open source hardware project.
10 years ago this would be unthinkable. The presentation they did was running
on a system with their chip on it. Very impressive. </p>
<p><img src="img/risc-v.jpg" alt="risc-v" style="width: 800px;" /></p>
<p>There were some other talks i went to. I will not go into detail
about them however. I have added quite a few items to my need-to-read-about
list. </p>
<table>
<thead>
<tr>
<th>Concept</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://git.tizen.org/cgit/tools/muxpi">muxpi</a></td>
<td>a remote controllable device to do embedded testing</td>
</tr>
<tr>
<td><a href="https://conan.io/">Conan</a></td>
<td>a C/C++ package manager for developers</td>
</tr>
<tr>
<td><a href="https://www.rtl-sdr.com/">RTL-SDR</a></td>
<td>Cheap SDR for hobbyists</td>
</tr>
<tr>
<td><a href="https://syslog-ng.org/">syslog-ng</a></td>
<td>syslog on steroids</td>
</tr>
<tr>
<td><a href="http://mqtt.org/">mqtt</a></td>
<td>Lightweight messaging protocol</td>
</tr>
<tr>
<td><a href="https://pagekite.net/">Pagekite</a></td>
<td>Network Tunneling</td>
</tr>
<tr>
<td><a href="https://en.wikipedia.org/wiki/Return-oriented_programming">ROP</a></td>
<td>Return oriented programming</td>
</tr>
</tbody>
</table>
<p>The degeneration of the word embedded is rampant. More and more speakers 
are (ab)using the term 'embedded' to lure in more attendants. </p>
<h2>Day 2</h2>
<p>During this day i was responsible for the video stream in the IoT devroom. 
Sadly the second to last speaker was unable to make it, causing the last talk
to be nearly empty. On the demo tables there was a group of people from 
<a href="https://www.uba.be/">HAMRADIO</a> showcasing an interesting SDR waterfall:</p>
<p><img src="img/hamradio.jpg" alt="HAMRadio" style="width: 800px;" /></p>
<p>After cleaning the devroom there was still time to attend
one last <a href="https://fosdem.org/2018/schedule/event/closing_keynote/">talk</a>. This
room was packed. Meltdown and spectre are big news after all.</p>
<p><img src="img/janson.jpg" alt="Janson" style="width: 800px;" /></p>
		</div> <!--/#entry-content-->
    		<span class="tag-links"><strong>Tagged</strong>
 <a href="/tag/fosdem.html" rel="tag">FOSDEM</a>,  <a href="/tag/opensource.html" rel="tag">OpenSource</a>    		</span>
	</div> <!--/#main-->
</div>  <!--/#post--><div class="post type-post status-publish format-standard hentry category-general" id="post">
	<div class="entry-meta">
		<div class="date"><a href="/blog-setup.html">za 10 februari 2018</a></div>
		<span class="byline">By <a href="/author/michiel-jordens.html">Michiel Jordens</a></span>
			<span class="cat-links"><a href="/category/python-ruby.html" title="View all posts in Python, Ruby" rel="category tag">Python, Ruby</a></span>
	</div> <!-- /#entry-meta -->
	<div class="main">
		<h2 class="entry-title">
			<a href="/blog-setup.html" title="Permalink to Setting up a blog" rel="bookmark">Setting up a blog</a>
		</h2>
		<div class="entry-content">
			<p>For personal development and portfolio showcasing, it makes sense 
to start a blog. I had already heard of github-pages and when 
pitching the idea to a friend he was quick to recommend jeckyll.</p>
<p>I was handed 3 tutorials to follow and was a little overwhelmed at first. 
There were quite a few difficulties trying to run jekyll. The combination 
of permission problems, rbenv and various other packages I needed to install
were quick to drive me away from jekyll. </p>
<p>Pelican to the rescue. This is an alternative to jekyll. It is a
python-based static webpage generator. I was amazed how quick it was
to get things up and running. <a href="https://fedoramagazine.org/make-github-pages-blog-with-pelican/">This blog</a>
was a great help.</p>
<p>It is a bit odd to me that most, if not all, tutorials on github-pages mention
jekyll as the go-to static webpage generator. For me, Pelican is a much better 
fit, at least for now.</p>
		</div> <!--/#entry-content-->
    		<span class="tag-links"><strong>Tagged</strong>
 <a href="/tag/pelican.html" rel="tag">pelican</a>,  <a href="/tag/publishing.html" rel="tag">publishing</a>    		</span>
	</div> <!--/#main-->
</div>  <!--/#post--><div class="navigation">
</div>
		</div>
		
		<div id="footer">
			<p>Powered by <a href="http://getpelican.com">Pelican</a>, theme by <a href="http://bunnyman.info">tBunnyMan</a>.</p>
		</div><!-- /#footer -->
	</div><!-- /#container -->
	<div style="display:none"></div>
</body>
</html>